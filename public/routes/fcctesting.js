/*
*
*
*
*
*
*
*
*
*
*
*
*       DO NOT EDIT THIS FILE
*       For FCC testing purposes!
*
*
*
*
*
*
*
*
*
*
*
*/
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _cors = _interopRequireDefault(require("cors"));

var _fs = _interopRequireDefault(require("fs"));

var _testRunner = require("../../test-runner");

function _default(app) {
  app.route('/_api/server.js').get(function (req, res, next) {
    console.log('requested');

    _fs["default"].readFile(__dirname + '/server.js', function (err, data) {
      if (err) return next(err);
      res.send(data.toString());
    });
  });
  app.route('/_api/routes/api.js').get(function (req, res, next) {
    console.log('requested');

    _fs["default"].readFile(__dirname + '/routes/api.js', function (err, data) {
      if (err) return next(err);
      res.type('txt').send(data.toString());
    });
  });
  app.route('/_api/controllers/convertHandler.js').get(function (req, res, next) {
    console.log('requested');

    _fs["default"].readFile(__dirname + '/controllers/convertHandler.js', function (err, data) {
      if (err) return next(err);
      res.type('txt').send(data.toString());
    });
  });
  var error;
  app.get('/_api/get-tests', (0, _cors["default"])(), function (req, res, next) {
    console.log(error);
    if (!error && process.env.NODE_ENV === 'test') return next();
    res.json({
      status: 'unavailable'
    });
  }, function (req, res, next) {
    if (!_testRunner.run.report) return next();
    res.json(testFilter(_testRunner.run.report, req.query.type, req.query.n));
  }, function (req, res) {
    _testRunner.run.on('done', function (report) {
      process.nextTick(function () {
        return res.json(testFilter(_testRunner.run.report, req.query.type, req.query.n));
      });
    });
  });
  app.get('/_api/app-info', function (req, res) {
    var hs = Object.keys(res.header).filter(function (h) {
      return !h.match(/^access-control-\w+/);
    });
    var hObj = {};
    hs.forEach(function (h) {
      hObj[h] = res.header[h];
    });
    delete res.header['strict-transport-security'];
    res.json({
      headers: hObj
    });
  });
}

;

function testFilter(tests, type, n) {
  var out;

  switch (type) {
    case 'unit':
      out = tests.filter(function (t) {
        return t.context.match('Unit Tests');
      });
      break;

    case 'functional':
      out = tests.filter(function (t) {
        return t.context.match('Functional Tests') && !t.title.match('#example');
      });
      break;

    default:
      out = tests;
  }

  if (n !== undefined) {
    return out[n] || out;
  }

  return out;
}