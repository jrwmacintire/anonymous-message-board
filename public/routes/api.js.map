{"version":3,"sources":["../../src/routes/api.ts"],"names":["boardController","BoardController","threadController","ThreadController","app","route","get","req","res","boardName","params","board","validateBoardByName","validBoardName","getBoardByName","console","log","send","createNewBoard","newBoard","status","post","body","thread_text","delete_password","Promise","all","validateBody","valid","validatedBoardName","validatedBody","createNewThread","id","thread","update","$push","_id","updateBoard","redirect","undefined","Error","put"],"mappings":"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","sourcesContent":["/*\r\n*\r\n*\r\n*       Complete the API routing below\r\n*\r\n*\r\n*/\r\n\r\n'use strict';\r\n\r\n// const expect = require('chai').expect;\r\n\r\nimport BoardController from '../controllers/boardController';\r\nconst boardController = new BoardController();\r\nimport ThreadController from '../controllers/threadController';\r\nconst threadController = new ThreadController();\r\nimport BoardInterface from '../interfaces/Board.interface';\r\nimport ResponseBody from '../interfaces/PostThreadBody.interface';\r\nimport { Request, Response, Application } from 'express';\r\nimport { ParamsDictionary } from 'express-serve-static-core';\r\nimport { Document } from 'mongoose';\r\n\r\nexport default function (app: Application) {\r\n\r\n  app.route('/api/threads/:board')\r\n    .get(async function (req: Request, res: Response) {\r\n\r\n      try {\r\n        const boardName: string = req.params.board;\r\n        const validBoardName = await boardController.validateBoardByName(boardName);\r\n\r\n        if (validBoardName) {\r\n          const board = await boardController.getBoardByName(boardName);\r\n          if (board) {\r\n            console.log(`Board FOUND:`, board);\r\n\r\n            // start: array of ObjectIDs from board's 'threads' array\r\n            //      : take 10 most recently bumped thread IDs from (index 0-9)\r\n            //      : query all docs with given thread IDs from DB\r\n            //      : parse raw thread docs into objects \r\n            //      : filter out 'delete_password' or 'reported' values from response array\r\n            //   end: parsed/filtered array of thread doc objects\r\n\r\n            res.send([]);\r\n          } else {\r\n            console.log('Board not found - prepare to create board!');\r\n            const newBoard = await boardController.createNewBoard(boardName);\r\n            res.send([]);\r\n          }\r\n\r\n          // validate boardName\r\n          // throw error if invalid\r\n          // query thread ids from board\r\n          // filter 10 threads with the highest bumps/replies\r\n          // display with json, or send 'No replies were found on this thread.'\r\n          // res.sendFile(process.cwd() + `/src/views/board.html`);\r\n\r\n        } else { // Invalid board name, send error response\r\n          res.status(400).send('Error: invalid board name');\r\n        }\r\n\r\n      } catch (err) {\r\n        // res.send(err);\r\n        throw err;\r\n      }\r\n\r\n    })\r\n    .post(async function (req: Request, res: Response) {\r\n      const boardName: string = req.params.board;\r\n      const body = {\r\n        thread_text: req.body.thread_text,\r\n        delete_password: req.body.delete_password\r\n      };\r\n\r\n      const valid = await Promise.all([\r\n        boardController.validateBoardByName(boardName),\r\n        boardController.validateBody(body)\r\n      ]);\r\n\r\n      const validatedBoardName: boolean = valid[0],\r\n        validatedBody: ResponseBody = valid[1];\r\n\r\n      interface ResponseBody {\r\n        thread_text: boolean,\r\n        delete_password: boolean\r\n      };\r\n\r\n      // console.log(`valid: `, valid);\r\n      // If board's name is valid\r\n      if (validatedBoardName) {\r\n        // use board controller query the DB for a matching board\r\n\r\n        const board = await boardController.getBoardByName(boardName);\r\n\r\n        // and both 'body' properties are valid\r\n        if (validatedBody.thread_text && validatedBody.delete_password && board !== null) {\r\n\r\n          if(board) {\r\n            const thread = await threadController.createNewThread(boardName, body, board.id);\r\n\r\n            const update = {\r\n              $push: {\r\n                \"threads\": thread._id\r\n              }\r\n            };\r\n\r\n            await boardController.updateBoard(board, thread._id);\r\n            // update board with thread's id in 'threads' array\r\n            \r\n            // then redirect to the newly created thread's board.\r\n            res.redirect(303, `/api/threads/${boardName}`);\r\n          } else {\r\n            res.send('Redirect failed, check if board exists...');\r\n          }\r\n        }\r\n        // the 'body' contains invalid info\r\n        else {\r\n          if(board === null || board === undefined) {\r\n            res.status(400).send('Board not found. Please create or search for a new board.');\r\n          } else if (!validatedBody.thread_text && !validatedBody.delete_password) {\r\n            // Error: all inputs invalid\r\n            res.status(400).send('Please ensure all input fields are filled out and try again.');\r\n          } else if (!validatedBody.thread_text) {\r\n            // Error: 'text' field is invalid\r\n            res.status(400).send('Invalid input for text. Please try again.');\r\n          } else if (!validatedBody.delete_password) {\r\n            // Error: 'delete_password' field is invalid\r\n            res.status(400).send('Invalid input for delete_password field. Please try again.');\r\n          } else {\r\n            throw Error('Catch all error for error-handling on body validation.');\r\n          }\r\n        }\r\n      } else {\r\n        res.status(400).send('Invalid input for board name. Please try again.');\r\n      }\r\n\r\n      // validate boardName with DB\r\n      // if not found, make a new board (any letter 'a-z')\r\n      // board is now found/created and ready for use\r\n      // validate the 'text' and 'delete_password' fields\r\n      // throw error if invalid \r\n      // or create new thread with model\r\n      // add new thread's id to current board\r\n      // add 'text' and 'delete_password'\r\n      // automatically generate other fields ('bumped_on, created_on')\r\n      // res.redirect(307, `/api/threads/${boardName}`);\r\n\r\n    })\r\n    .put(function (req: Request, res: Response) {\r\n      res.send(req.body);\r\n    })\r\n    .delete(function (req: Request, res: Response) {\r\n      res.send('Request to delete a thread?');\r\n    });\r\n\r\n  app.route('/api/replies/:board')\r\n    .get(function (req: Request, res: Response) {\r\n      const params: ParamsDictionary = req.params;\r\n      res.send(`params: ${params}`);\r\n    })\r\n    .post(function (req: Request, res: Response) {\r\n      res.send(req.body);\r\n    })\r\n    .put(function (req: Request, res: Response) {\r\n      res.send(req.body);\r\n    })\r\n    .delete(function (req: Request, res: Response) {\r\n      res.send(req.body);\r\n    });\r\n\r\n};\r\n"],"file":"api.js"}